WITH DETALLE AS (
        SELECT  ANIO_OCURRENCIA,CODIGO_RAMO_CONTABLE, CODIGO_PRODUCTO, NUMERO_POLIZA, NUMERO_SINIESTRO,
                INCURRIDO_BRUTO, INCURRIDO_CEDIDO, LIQUIDADO_BRUTO, LIQUIDADO_CEDIDO,
                (INCURRIDO_BRUTO - INCURRIDO_CEDIDO) AS INCURRIDO_NETO,
                (LIQUIDADO_BRUTO - LIQUIDADO_CEDIDO) AS LIQUIDADO_NETO,
                (INCURRIDO_BRUTO - INCURRIDO_CEDIDO) - (LIQUIDADO_BRUTO - LIQUIDADO_CEDIDO) AS RESERVA
        FROM(
                SELECT  EXTRACT(YEAR FROM FECHA_SINIESTRO) AS ANIO_OCURRENCIA, 
                        CODIGO_RAMO_CONTABLE, CODIGO_PRODUCTO, NUMERO_POLIZA, NUMERO_SINIESTRO,
                        SUM(INCURRIDO_BOLIVAR) AS INCURRIDO_BRUTO,
                        (SUM(INCURRIDO_REA_PROP_CONTRATOS)+ SUM(INCURRIDO_REA_PROP_FACULTATIVO)) AS INCURRIDO_CEDIDO,
                        SUM(LIQUIDADO_BOLIVAR) AS LIQUIDADO_BRUTO,
                        (SUM(LIQUIDADO_REA_PROP_CONTRATOS)+ SUM(LIQUIDADO_REA_PROP_FACULTATIVO)) AS LIQUIDADO_CEDIDO,

                FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros
                WHERE CODIGO_COMPANIA = 3 AND CODIGO_PRODUCTO IN (91, 93 ,94, 95, 97 , 98 , 173 , 777, 778)
                AND EXPEDIENTE NOT IN ('RES','RSS','RCU')
                GROUP BY ALL
        )
        -- ORDER BY CODIGO_RAMO_CONTABLE,CODIGO_PRODUCTO, ANIO_OCURRENCIA, NUMERO_POLIZA, NUMERO_SINIESTRO
),

AGRUPADO AS (
        SELECT ANIO_OCURRENCIA,CODIGO_RAMO_CONTABLE,CODIGO_PRODUCTO, SUM(INCURRIDO_NETO) AS INC_NETO, SUM(LIQUIDADO_NETO) AS LIQ_NETO, SUM(RESERVA )AS RESERVA
        FROM DETALLE
        GROUP BY ALL
        HAVING RESERVA != 0
        ORDER BY CODIGO_RAMO_CONTABLE,CODIGO_PRODUCTO, ANIO_OCURRENCIA
)

SELECT * FROM AGRUPADO
ORDER BY CODIGO_RAMO_CONTABLE,CODIGO_PRODUCTO, ANIO_OCURRENCIA





## Con bruto

WITH DETALLE AS (
        SELECT  ANIO_OCURRENCIA,CODIGO_RAMO_CONTABLE, CODIGO_PRODUCTO, NUMERO_POLIZA, NUMERO_SINIESTRO,
                INCURRIDO_BRUTO, INCURRIDO_CEDIDO, LIQUIDADO_BRUTO, LIQUIDADO_CEDIDO,
                (INCURRIDO_BRUTO - INCURRIDO_CEDIDO) AS INCURRIDO_NETO,
                (LIQUIDADO_BRUTO - LIQUIDADO_CEDIDO) AS LIQUIDADO_NETO,
                (INCURRIDO_BRUTO - INCURRIDO_CEDIDO) - (LIQUIDADO_BRUTO - LIQUIDADO_CEDIDO) AS RESERVA
        FROM(
                SELECT  EXTRACT(YEAR FROM FECHA_SINIESTRO) AS ANIO_OCURRENCIA, 
                        CODIGO_RAMO_CONTABLE, CODIGO_PRODUCTO, NUMERO_POLIZA, NUMERO_SINIESTRO,
                        SUM(INCURRIDO_BOLIVAR) AS INCURRIDO_BRUTO,
                        (SUM(INCURRIDO_REA_PROP_CONTRATOS)+ SUM(INCURRIDO_REA_PROP_FACULTATIVO)) AS INCURRIDO_CEDIDO,
                        SUM(LIQUIDADO_BOLIVAR) AS LIQUIDADO_BRUTO,
                        (SUM(LIQUIDADO_REA_PROP_CONTRATOS)+ SUM(LIQUIDADO_REA_PROP_FACULTATIVO)) AS LIQUIDADO_CEDIDO,

                FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros
                WHERE CODIGO_COMPANIA = 3 AND CODIGO_PRODUCTO IN (91, 93 ,94, 95, 97 , 98 , 173 , 777, 778)
                AND EXPEDIENTE NOT IN ('RES','RSS','RCU')
                GROUP BY ALL
        )
        -- ORDER BY CODIGO_RAMO_CONTABLE,CODIGO_PRODUCTO, ANIO_OCURRENCIA, NUMERO_POLIZA, NUMERO_SINIESTRO
),

AGRUPADO AS (
        SELECT ANIO_OCURRENCIA,CODIGO_RAMO_CONTABLE,CODIGO_PRODUCTO, SUM (INCURRIDO_BRUTO) AS INC_BRUTO, SUM(LIQUIDADO_BRUTO) AS LIQ_BRUTO, SUM(INCURRIDO_NETO) AS INC_NETO, SUM(LIQUIDADO_NETO) AS LIQ_NETO, SUM(RESERVA )AS RESERVA
        FROM DETALLE
        GROUP BY ALL
        HAVING RESERVA != 0
        ORDER BY CODIGO_RAMO_CONTABLE,CODIGO_PRODUCTO, ANIO_OCURRENCIA
)

SELECT * FROM AGRUPADO
ORDER BY CODIGO_RAMO_CONTABLE,CODIGO_PRODUCTO, ANIO_OCURRENCIA
