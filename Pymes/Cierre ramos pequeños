Primas
SELECT 
CODIGO_COMPANIA,
CODIGO_RAMO_CONTABLE, 
CODIGO_RAMO_EMISION, 
CODIGO_PRODUCTO, 
CODIGO_LOCALIDAD, 
CLAVE_AGENTE, 
NUMERO_POLIZA, 
NUMERO_POLIZA_MADRE, 
ALTURA_POLIZA, 
TIPO_NEGOCIO, 
TIPO_CLIENTE, 
REFERIDO, 
NUMERO_ENDOSO, 
TIPO_ENDOSO, 
PERIODO_FACTURACION, 
NUMERO_FACTURA, 
NOMBRE_TOMADOR, 
TIPO_DOCUMENTO_TOMADOR, 
KEY_ID_TOMADOR, 
DATE(FECHA_EMISION_ENDOSO) FECHA_EMISION_ENDOSO, 
DATE(FECHA_VENCIMIENTO_ENDOSO) FECHA_VENCIMIENTO_ENDOSO, 
FECHA_CORTE, 
DATE(FECHA_CIERRE) FECHA_CIERRE, 
CODIGO_MONEDA, 
TASA_CAMBIO_GENERAL, 
CAST(IMPUESTOS AS INT64) IMPUESTOS, 
CAST(PRIMA_ENDOSO_GENERAL AS INT64) PRIMA_ENDOSO_GENERAL, 
COMISION_INTERMEDIACION, 
CASE WHEN CODIGO_PRODUCTO IN (1,75,76) THEN "PROPIEDAD"
    WHEN CODIGO_PRODUCTO IN (40,45) THEN "TRANSPORTES"
    ELSE "OTROS" END AS LINEA_NEGOCIO
FROM `sb-ecosistemaanalitico-lago.datamart.t_produccion_detalle`
WHERE CODIGO_PRODUCTO IN (1,75,76,40,45, 8,120,125,154,200,755,770,790,910) #923
--AND REFERIDO = "NO"
AND DATE(FECHA_CIERRE) BETWEEN "2025-01-01" AND LAST_DAY("2025-04-01", MONTH)
--GROUP BY 1


Siniestros
WITH SINIESTRO_DETALLE AS (
  SELECT 
    FECHA_CORTE_MOVIMIENTO,
    CASE WHEN CODIGO_PRODUCTO IN (1,75,76) THEN 'PROPIEDAD' 
        WHEN CODIGO_PRODUCTO IN (40,45) THEN 'TRANSPORTES'
        ELSE 'OTROS' END AS LINEA_NEGOCIO,
    CODIGO_PRODUCTO,
    NUMERO_SINIESTRO,
    TIPO_DOCUMENTO_TOMADOR, 
    KEY_ID_TOMADOR, 
    TIPO_DOCUMENTO_ASEGURADO, 
    KEY_ID_ASEGURADO,  
    NUMERO_POLIZA_MADRE, 
    NUMERO_POLIZA, 
    CASE WHEN NUMERO_POLIZA_MADRE IS NULL THEN NUMERO_POLIZA ELSE NUMERO_POLIZA_MADRE END AS NUMERO_POLIZA_MADRE_AUX,
    NUMERO_SECUENCIA_POLIZA,
    CODIGO_RAMO_CONTABLE, 
    NOMBRE_RAMO_CONTABLE,
    CODIGO_COBERTURA, 
    NOMBRE_COBERTURA, 
    DATE(FECHA_AVISO) FECHA_AVISO, 
    DATE(FECHA_SINIESTRO) FECHA_SINIESTRO, 
    ESTADO_SINIESTRO_CALCULADO, 
    DESCRIPCION_SINIESTRO, 
    
    CAST(SUM(INCURRIDO_BOLIVAR) AS INT64) AS INCURRIDO_BOLIVAR,
    CAST(SUM(INCURRIDO_REA_PROP_CONTRATOS) AS INT64) AS INCURRIDO_REA_PROP_CONTRATOS,
    CAST(SUM(INCURRIDO_REA_PROP_FACULTATIVO) AS INT64) AS INCURRIDO_REA_PROP_FACULTATIVO,

    CAST(SUM(LIQUIDADO_BOLIVAR) AS INT64) AS LIQUIDADO_BOLIVAR,
    CAST(SUM(LIQUIDADO_REA_PROP_CONTRATOS) AS INT64) AS LIQUIDADO_REA_PROP_CONTRATOS,
    CAST(SUM(LIQUIDADO_REA_PROP_FACULTATIVO) AS INT64) AS LIQUIDADO_REA_PROP_FACULTATIVO,

    CAST(SUM(INCURRIDO_BOLIVAR_AUX) AS INT64) AS INCURRIDO_BOLIVAR_AUX,
    CAST(SUM(INCURRIDO_REA_PROP_CONTRATOS_AUX) AS INT64) AS INCURRIDO_REA_PROP_CONTRATOS_AUX,
    CAST(SUM(INCURRIDO_REA_PROP_FACULTATIVO_AUX) AS INT64) AS INCURRIDO_REA_PROP_FACULTATIVO_AUX,

    CAST(SUM(LIQUIDADO_BOLIVAR_AUX) AS INT64) AS LIQUIDADO_BOLIVAR_AUX,
    CAST(SUM(LIQUIDADO_REA_PROP_CONTRATOS_AUX) AS INT64) AS LIQUIDADO_REA_PROP_CONTRATOS_AUX,
    CAST(SUM(LIQUIDADO_REA_PROP_FACULTATIVO_AUX) AS INT64) AS LIQUIDADO_REA_PROP_FACULTATIVO_AUX,

    -1*CAST(SUM(LIQUIDADO_BOLIVAR_AUX) AS INT64) AS SINIESTROS_PAGADOS,
    CAST((SUM(LIQUIDADO_REA_PROP_CONTRATOS_AUX) + SUM(LIQUIDADO_REA_PROP_FACULTATIVO_AUX)) AS INT64) AS REEMBOLSOS,
    CAST(SUM(RECOBROS_SALVAMENTOS) AS INT64) AS RECOBROS_SALVAMENTOS,
    CAST(
        (
            SUM(LIQUIDADO_BOLIVAR_AUX) - SUM(INCURRIDO_BOLIVAR_AUX) +
            (SUM(INCURRIDO_REA_PROP_CONTRATOS_AUX) + SUM(INCURRIDO_REA_PROP_FACULTATIVO_AUX)) - 
            (SUM(LIQUIDADO_REA_PROP_CONTRATOS_AUX) + SUM(LIQUIDADO_REA_PROP_FACULTATIVO_AUX))
        ) AS INT64
    ) AS CAMBIO_RESERVA

FROM (
    SELECT 
        *,
        DATE_TRUNC(DATE(FECHA_MOVIMIENTO), MONTH) AS FECHA_CORTE_MOVIMIENTO,
        CASE WHEN EXPEDIENTE IN ('RES', 'WRS') THEN 0 ELSE INCURRIDO_BOLIVAR END AS INCURRIDO_BOLIVAR_AUX, 
        CASE WHEN EXPEDIENTE IN ('RES', 'WRS') THEN 0 ELSE INCURRIDO_REA_PROP_CONTRATOS END AS INCURRIDO_REA_PROP_CONTRATOS_AUX, 
        CASE WHEN EXPEDIENTE IN ('RES', 'WRS') THEN 0 ELSE INCURRIDO_REA_PROP_FACULTATIVO END AS INCURRIDO_REA_PROP_FACULTATIVO_AUX, 
        
        CASE WHEN EXPEDIENTE IN ('RES', 'WRS') THEN 0 ELSE LIQUIDADO_BOLIVAR END AS LIQUIDADO_BOLIVAR_AUX, 
        CASE WHEN EXPEDIENTE IN ('RES', 'WRS') THEN 0 ELSE LIQUIDADO_REA_PROP_CONTRATOS END AS LIQUIDADO_REA_PROP_CONTRATOS_AUX, 
        CASE WHEN EXPEDIENTE IN ('RES', 'WRS') THEN 0 ELSE LIQUIDADO_REA_PROP_FACULTATIVO END AS LIQUIDADO_REA_PROP_FACULTATIVO_AUX, 

        CASE WHEN EXPEDIENTE IN ('RES', 'WRS') THEN LIQUIDADO_BOLIVAR ELSE 0 END AS RECOBROS_SALVAMENTOS
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
    WHERE CODIGO_PRODUCTO IN (1,75,76,40,45, 8,120,125,154,200,755,770,790,910) #923
    AND  DATE_TRUNC(DATE(FECHA_MOVIMIENTO), MONTH) >= "2025-01-01"
)
GROUP BY 
    FECHA_CORTE_MOVIMIENTO,
    CODIGO_PRODUCTO,  
    NUMERO_SINIESTRO,
    TIPO_DOCUMENTO_TOMADOR, 
    KEY_ID_TOMADOR, 
    TIPO_DOCUMENTO_ASEGURADO, 
    KEY_ID_ASEGURADO,  
    NUMERO_POLIZA_MADRE, 
    NUMERO_POLIZA, 
    NUMERO_SECUENCIA_POLIZA,
    CODIGO_RAMO_CONTABLE,
    NOMBRE_RAMO_CONTABLE,
    CODIGO_COBERTURA, 
    NOMBRE_COBERTURA, 
    FECHA_AVISO, 
    FECHA_SINIESTRO, 
    ESTADO_SINIESTRO_CALCULADO, 
    DESCRIPCION_SINIESTRO
)

# OTRA INFO COMPLEMENTARIA
# Nombre tomador
, TOMADOR AS (  
  SELECT * FROM(
    SELECT 
    DISTINCT 
    KEY_ID_TOMADOR, 
    NOMBRE_TOMADOR, 
    ROW_NUMBER() OVER(PARTITION BY KEY_ID_TOMADOR ORDER BY FECHA_CORTE DESC) AS FILTRO
    FROM sb-ecosistemaanalitico-lago.datamart.t_produccion_detalle
    WHERE KEY_ID_TOMADOR IN (SELECT DISTINCT KEY_ID_TOMADOR FROM SINIESTRO_DETALLE))
  WHERE FILTRO = 1
)

# Información de t empresas razon social, codigo ciiu y sector economico, se extrae la info asociada a la ultima fecha de actualizacion
, INFO_T_EMPRESAS AS (
  SELECT *EXCEPT(ULTIMA_FECHA_CORTE) FROM (
    SELECT DISTINCT  
    FECHA_CORTE, 
    RAZON_SOCIAL,
    TIPO_DOCUMENTO, 
    NUMERO_DOCUMENTO, 
    CODIGO_CIIU, 
    SECTOR_ECONOMICO, 
    CASE WHEN ROW_NUMBER() OVER (PARTITION BY NUMERO_DOCUMENTO ORDER BY FECHA_CORTE DESC) = 1 THEN 1 ELSE 0 END AS  ULTIMA_FECHA_CORTE, 
    FROM `sb-ecosistemaanalitico-lago.golden_records.t_empresas`
    WHERE CAST(NUMERO_DOCUMENTO AS STRING) IN (SELECT DISTINCT KEY_ID_TOMADOR FROM SINIESTRO_DETALLE))
  WHERE ULTIMA_FECHA_CORTE = 1
)

# Información de t clientes juridicoss codigo ciiu, se extrae la info asociada a la ultima fecha de actualizacion
, INFO_T_CLIENTES_JURIDICOS AS (
  SELECT *EXCEPT(FILTRO) FROM (
    SELECT DISTINCT  
    DATE(FECHA_ACTUALIZACION) FECHA_ACTUALIZACION, 
    NOMBRE,
    TIPO_DOCUMENTO, 
    KEY_ID,
    CODIGO_CIIU, 
    CASE WHEN ROW_NUMBER() OVER (PARTITION BY TIPO_DOCUMENTO, KEY_ID ORDER BY FECHA_ACTUALIZACION DESC) = 1 THEN 1 ELSE 0 END AS  FILTRO, 
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_juridicos`
    WHERE CAST(KEY_ID AS STRING) IN (SELECT DISTINCT KEY_ID_TOMADOR FROM SINIESTRO_DETALLE))
  WHERE FILTRO = 1
)

, CORPORATIVOS AS (
  SELECT 
  DISTINCT 
  ID_CLIENTE, 
  MARCA,
  'S' AS MARCA_CORPORATIVO
  FROM sb-ecosistemaanalitico-lago.bi.dk_clientes_corporativos 
  WHERE CAST(ID_CLIENTE AS STRING) IN (SELECT DISTINCT KEY_ID_TOMADOR FROM SINIESTRO_DETALLE)
  )

# Info complementaria final
, INFO_COMPLEMENTARIA AS (
  SELECT 
  T1.KEY_ID_TOMADOR,
  T1.NOMBRE_TOMADOR AS RAZON_SOCIAL, 
  
  T2.SECTOR_ECONOMICO,
  IFNULL(T2.CODIGO_CIIU, T3.CODIGO_CIIU) AS CODIGO_CIIU,

  T4.MARCA_CORPORATIVO
  FROM TOMADOR T1
  LEFT JOIN INFO_T_EMPRESAS T2
  ON T1.KEY_ID_TOMADOR = CAST(T2.NUMERO_DOCUMENTO AS STRING)
  
  LEFT JOIN INFO_T_CLIENTES_JURIDICOS T3 
  ON T1.KEY_ID_TOMADOR = CAST(T3.KEY_ID AS STRING)

  LEFT JOIN CORPORATIVOS T4
  ON T1.KEY_ID_TOMADOR = CAST(T4.ID_CLIENTE AS STRING)
)

# Poliza madre
, POLIZA_MADRE1 AS (
  SELECT 
  DISTINCT 
  CODIGO_PRODUCTO, 
  NUMERO_POLIZA_MADRE, 
  MARCA_REFERIDO 
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos`
  WHERE CODIGO_PRODUCTO IN (1,40,45,75,76,91,93,94,95,97,98,173,777,778)
  AND NUMERO_POLIZA_MADRE IN (SELECT DISTINCT NUMERO_POLIZA_MADRE_AUX FROM SINIESTRO_DETALLE)
)

, POLIZA_MADRE2 AS (
  SELECT 
  DISTINCT 
  CODIGO_PRODUCTO,
  NUMERO_POLIZA_MADRE,
  NUMERO_POLIZA, 
  MARCA_REFERIDO 
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos`
  WHERE CODIGO_PRODUCTO IN (1,40,45,75,76,91,93,94,95,97,98,173,777,778)
  AND NUMERO_POLIZA IN (SELECT DISTINCT NUMERO_POLIZA FROM SINIESTRO_DETALLE)
)

, FINAL AS (
  SELECT 
  
  T2.*EXCEPT(KEY_ID_TOMADOR, MARCA_CORPORATIVO),
  CASE WHEN T2.MARCA_CORPORATIVO IS NULL THEN 'N' ELSE MARCA_CORPORATIVO END AS MARCA_CORPORATIVO,
  T1.*EXCEPT(NUMERO_POLIZA_MADRE, NUMERO_POLIZA_MADRE_AUX),
  IFNULL(T3.NUMERO_POLIZA_MADRE, T4.NUMERO_POLIZA_MADRE) NUMERO_POLIZA_MADRE,
  IFNULL(T3.MARCA_REFERIDO, T4.MARCA_REFERIDO) MARCA_REFERIDO,
  SAFE_DIVIDE(T1.INCURRIDO_REA_PROP_CONTRATOS, T1.INCURRIDO_BOLIVAR) AS PORC_CESION_INCURRIDO_REA_PROP,
  SAFE_DIVIDE(T1.INCURRIDO_REA_PROP_FACULTATIVO, T1.INCURRIDO_BOLIVAR) AS PORC_CESION_INCURRIDO_REA_FACULTATIVO,
  SAFE_DIVIDE(T1.LIQUIDADO_REA_PROP_CONTRATOS, T1.LIQUIDADO_BOLIVAR) AS PORC_CESION_LIQUIDADO_REA_PROP,
  SAFE_DIVIDE(T1.LIQUIDADO_REA_PROP_FACULTATIVO, T1.LIQUIDADO_BOLIVAR) AS PORC_CESION_LIQUIDADO_REA_FACULTATIVO

  FROM (SELECT * FROM SINIESTRO_DETALLE) T1
  
  LEFT JOIN INFO_COMPLEMENTARIA T2
  ON T1.KEY_ID_TOMADOR = T2.KEY_ID_TOMADOR
  
  LEFT JOIN POLIZA_MADRE1 T3
  ON T1.NUMERO_POLIZA_MADRE_AUX = T3.NUMERO_POLIZA_MADRE
  AND T1.CODIGO_PRODUCTO = T3.CODIGO_PRODUCTO

  LEFT JOIN POLIZA_MADRE2 T4
  ON T1.NUMERO_POLIZA = T4.NUMERO_POLIZA
  AND T1.CODIGO_PRODUCTO = T4.CODIGO_PRODUCTO

  )

SELECT 

FECHA_CORTE_MOVIMIENTO,
CODIGO_PRODUCTO,
LINEA_NEGOCIO,
NUMERO_POLIZA_MADRE,
NUMERO_POLIZA,
NUMERO_SECUENCIA_POLIZA,
RAZON_SOCIAL,
MARCA_REFERIDO,
MARCA_CORPORATIVO,
SECTOR_ECONOMICO,
CODIGO_CIIU,
TIPO_DOCUMENTO_TOMADOR,
KEY_ID_TOMADOR,
TIPO_DOCUMENTO_ASEGURADO,
KEY_ID_ASEGURADO,
NUMERO_SINIESTRO,
CODIGO_RAMO_CONTABLE, 
NOMBRE_RAMO_CONTABLE,
CODIGO_COBERTURA,
NOMBRE_COBERTURA,
FECHA_AVISO,
FECHA_SINIESTRO,
ESTADO_SINIESTRO_CALCULADO,
REGEXP_REPLACE(DESCRIPCION_SINIESTRO, r'[.,;:!?"()\-]', '') AS DESCRIPCION_SINIESTRO,
INCURRIDO_BOLIVAR,
INCURRIDO_REA_PROP_CONTRATOS,
INCURRIDO_REA_PROP_FACULTATIVO,
PORC_CESION_INCURRIDO_REA_PROP,
PORC_CESION_INCURRIDO_REA_FACULTATIVO,
LIQUIDADO_BOLIVAR,
LIQUIDADO_REA_PROP_CONTRATOS,
LIQUIDADO_REA_PROP_FACULTATIVO,
PORC_CESION_LIQUIDADO_REA_PROP,
PORC_CESION_LIQUIDADO_REA_FACULTATIVO,
INCURRIDO_BOLIVAR_AUX,
INCURRIDO_REA_PROP_CONTRATOS_AUX,
INCURRIDO_REA_PROP_FACULTATIVO_AUX,
LIQUIDADO_BOLIVAR_AUX,
LIQUIDADO_REA_PROP_CONTRATOS_AUX,
LIQUIDADO_REA_PROP_FACULTATIVO_AUX,
SINIESTROS_PAGADOS,
REEMBOLSOS,
RECOBROS_SALVAMENTOS,
CAMBIO_RESERVA

 FROM FINAL
