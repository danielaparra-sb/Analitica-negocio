WITH SINIESTROS AS (
      SELECT 
CASE WHEN CODIGO_PRODUCTO IN (250) THEN 'AUTOS' 
      WHEN CODIGO_PRODUCTO IN (777,778) THEN 'TRANQUILIDAD_PYMES'
      ELSE 'MULTIRRIESGO_PYMES' END AS SEGMENTO, 
DATE(FECHA_AVISO) FECHA_AVISO, 
CODIGO_PRODUCTO, 
CODIGO_SUBPRODUCTO, 
NUMERO_SINIESTRO, 
CODIGO_COBERTURA, 
NOMBRE_COBERTURA, 
CODIGO_RAMO_CONTABLE, 
NOMBRE_RAMO_CONTABLE,
ESTADO_SINIESTRO_CALCULADO,
DESCRIPCION_SINIESTRO,
SUM(CASE WHEN EXPEDIENTE IN ('RES','WRS','RSS') THEN -1*INCURRIDO_BOLIVAR ELSE INCURRIDO_BOLIVAR END) INCURRIDO_TOTAL_BOLIVAR, 
SUM(CASE WHEN EXPEDIENTE IN ('RES','WRS','RSS') THEN -1*LIQUIDADO_BOLIVAR ELSE LIQUIDADO_BOLIVAR END) LIQUIDADO_TOTAL_BOLIVAR, 
--SUM(CASE WHEN EXPEDIENTE IN ('GSO') THEN INCURRIDO_BOLIVAR ELSE 0 END) INCURRIDO_GASTOS, 
--SUM(CASE WHEN EXPEDIENTE IN ('GSO') THEN LIQUIDADO_BOLIVAR ELSE 0 END) LIQUIDADO_GASTOS
 FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
WHERE CODIGO_PRODUCTO IN (91, 93 ,94, 95, 97 , 98 , 173 , 777, 778 , 250)
GROUP BY 1,2,3,4,5,6,7,8,9,10,11
ORDER BY SEGMENTO DESC, FECHA_AVISO ASC, CODIGO_COBERTURA ASC 
) 

, FINAL AS ( 
SELECT *, 
(INCURRIDO_TOTAL_BOLIVAR - LIQUIDADO_TOTAL_BOLIVAR) DIFERENCIA, 
CASE WHEN (INCURRIDO_TOTAL_BOLIVAR - LIQUIDADO_TOTAL_BOLIVAR) = 0 THEN 0 ELSE 1 END AS MARCA_DIFERENCIA
FROM SINIESTROS
)


SELECT * FROM FINAL
WHERE MARCA_DIFERENCIA = 1
AND CODIGO_PRODUCTO  = 777
