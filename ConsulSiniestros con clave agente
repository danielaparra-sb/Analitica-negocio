--SELECT * FROM sandbox_patrimonial.SINIESTROS_TPYMES

DECLARE FECHA_I DATE DEFAULT '2024-01-01';
DECLARE FECHA_F DATE DEFAULT CURRENT_DATE();
DECLARE COD_PROD INT64 DEFAULT 777;

----------------------- siniestros linea de negocio pymes -------------------------------------------------------------------------------------------------------

CREATE OR REPLACE TABLE sandbox_patrimonial.SINIESTROS_LN_PYMES AS

WITH SINIESTROS_LN_PYMES AS (
   SELECT * FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
   WHERE CODIGO_PRODUCTO IN (777,778,91,93,95,97,98,173)
   AND DATE(FECHA_MOVIMIENTO) >= FECHA_I
   )
SELECT * FROM SINIESTROS_LN_PYMES
;

----------------------- siniestros tranquilidad pymes -------------------------------------------------------------------------------------------------------
CREATE OR REPLACE TABLE sandbox_patrimonial.SINIESTROS_TPYMES AS

WITH SINIESTROS_TPYMES AS (
SELECT 
    NUMERO_POLIZA, 
    CLAVE_AGENTE, -- CAMPO AGREGADO
    NUMERO_SINIESTRO, 
    CODIGO_PRODUCTO, 
    NOMBRE_RAMO_CONTABLE,
    DESCRIPCION_CAUSA, 
    DATE_TRUNC(DATE(FECHA_MOVIMIENTO),MONTH) FECHA_MOVIMIENTO, 
    DATE_TRUNC(DATE(FECHA_AVISO), MONTH) FECHA_AVISO,
    TIPO_RIESGO_UIFA,
    DESCRIPCION_SINIESTRO AS COMO_FUE,
    CAST(SUM(INCURRIDO_BOLIVAR) AS INT64) INCURRIDO_BOLIVAR, 
    CAST(SUM(INCURRIDO_REA_PROP_CONTRATOS) AS INT64) INCURRIDO_REA, 
    (IFNULL(CAST(SUM(INCURRIDO_BOLIVAR) AS INT64),0) - IFNULL(CAST(SUM(INCURRIDO_REA_PROP_CONTRATOS) AS INT64),0)) RETENIDO_BOLIVAR
FROM sandbox_patrimonial.SINIESTROS_LN_PYMES
WHERE CODIGO_PRODUCTO in (778,777)
-- Se ajustó el GROUP BY para incluir la columna nueva (ahora son 10 campos antes de las sumas)
GROUP BY 1,2,3,4,5,6,7,8,9,10)

, SINIESTROS_FINAL AS (
SELECT A.* FROM (SELECT * FROM SINIESTROS_TPYMES) A
)

SELECT 
    NUMERO_POLIZA,
    CLAVE_AGENTE, -- CAMPO AGREGADO AL FINAL SELECT
    NUMERO_SINIESTRO,
    CODIGO_PRODUCTO,  
    NOMBRE_RAMO_CONTABLE,   
    DESCRIPCION_CAUSA,
    FECHA_MOVIMIENTO, 
    FECHA_AVISO,   
    TIPO_RIESGO_UIFA, 
    INCURRIDO_BOLIVAR,   
    INCURRIDO_REA, 
    RETENIDO_BOLIVAR, 
    COMO_FUE
FROM SINIESTROS_FINAL
;

----------------------- siniestros multirriesgo -------------------------------------------------------------------------------------------------------
CREATE OR REPLACE TABLE sandbox_patrimonial.SINIESTROS_MULTIPYMES AS

WITH SINIESTROS_MULTIPYMES AS (

SELECT 
    NUMERO_POLIZA, 
    CLAVE_AGENTE, -- CAMPO AGREGADO
    NUMERO_SINIESTRO, 
    CODIGO_PRODUCTO, 
    NOMBRE_RAMO_CONTABLE,
    DESCRIPCION_CAUSA, 
    DATE_TRUNC(DATE(FECHA_MOVIMIENTO),MONTH) FECHA_MOVIMIENTO, 
    DATE_TRUNC(DATE(FECHA_AVISO), MONTH) FECHA_AVISO,
    TIPO_RIESGO_UIFA,
    DESCRIPCION_SINIESTRO AS COMO_FUE,
    CAST(SUM(INCURRIDO_BOLIVAR) AS INT64) INCURRIDO_BOLIVAR, 
    CAST(SUM(INCURRIDO_REA_PROP_CONTRATOS) AS INT64) INCURRIDO_REA, 
    (IFNULL(CAST(SUM(INCURRIDO_BOLIVAR) AS INT64),0) - IFNULL(CAST(SUM(INCURRIDO_REA_PROP_CONTRATOS) AS INT64),0)) RETENIDO_BOLIVAR
FROM sandbox_patrimonial.SINIESTROS_LN_PYMES
WHERE CODIGO_PRODUCTO IN (91,93,95,97,98,173)
-- Se ajustó el GROUP BY para incluir la columna nueva
GROUP BY 1,2,3,4,5,6,7,8,9,10)

, SINIESTROS_FINAL AS (
SELECT A.* FROM (SELECT * FROM SINIESTROS_MULTIPYMES) A
)

SELECT 
    NUMERO_POLIZA,
    CLAVE_AGENTE, -- CAMPO AGREGADO AL FINAL SELECT
    NUMERO_SINIESTRO,
    CODIGO_PRODUCTO,  
    NOMBRE_RAMO_CONTABLE,   
    DESCRIPCION_CAUSA,
    FECHA_MOVIMIENTO, 
    FECHA_AVISO,   
    TIPO_RIESGO_UIFA, 
    INCURRIDO_BOLIVAR,   
    INCURRIDO_REA, 
    RETENIDO_BOLIVAR, 
    COMO_FUE
FROM SINIESTROS_FINAL
;
